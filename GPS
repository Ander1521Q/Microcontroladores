#include <xc.h>
#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#define _XTAL_FREQ 8000000  // Frecuencia del cristal (8 MHz)

#pragma config FOSC = HSPLL_HS, WDT = OFF, LVP = OFF, PBADEN = OFF

// ==== CONFIGURACIÃ“N DE PINES LCD ====
#define RS LATBbits.LATB2
#define EN LATBbits.LATB3
#define D4 LATDbits.LATD4
#define D5 LATDbits.LATD5
#define D6 LATDbits.LATD6
#define D7 LATDbits.LATD7

// ==== PROTOTIPOS ====
void LCD_Init(void);
void LCD_Command(unsigned char cmd);
void LCD_Char(unsigned char data);
void LCD_String(const char *msg);
void LCD_Clear(void);
void LCD_SetCursor(unsigned char row, unsigned char col);
void UART_Init(void);
char UART_Read(void);
void parseGPGGA(char *nmea);
void mostrarDatos(void);

// ==== VARIABLES GLOBALES ====
char buffer[100];
char hora[10], lat[15], lon[15], alt[10];
unsigned char i = 0;

void main(void) {
    TRISBbits.TRISB2 = 0;
    TRISBbits.TRISB3 = 0;
    TRISD &= 0x0F;       // RD4-RD7 como salida
    LATB = 0x00;
    LATD = 0x00;
    TRISCbits.TRISC7 = 1; // RX
    TRISCbits.TRISC6 = 0; // TX

    LCD_Init();
    UART_Init();
    LCD_String(" Esperando GPS ");
    __delay_ms(2000);
    LCD_Clear();

    while (1) {
        char c = UART_Read();
        if (c == '$') {
            i = 0;
            buffer[i++] = c;
            while (i < 99) {
                c = UART_Read();
                if (c == '\n') break;
                buffer[i++] = c;
            }
            buffer[i] = '\0';

            if (strstr(buffer, "$GPGGA") != NULL) {
                parseGPGGA(buffer);
                mostrarDatos();
            }
        }
    }
}

// ==== UART ====
void UART_Init(void) {
    SPBRG = 51; // 9600 bps con Fosc = 8MHz
    BRGH = 1;
    SYNC = 0;
    SPEN = 1;
    TXEN = 1;
    CREN = 1;
}

char UART_Read(void) {
    while (!RCIF);
    return RCREG;
}

// ==== LCD ====
void LCD_Pulse(void) {
    EN = 1; __delay_us(500);
    EN = 0; __delay_us(500);
}

void LCD_Command(unsigned char cmd) {
    RS = 0;
    D4 = (cmd >> 4) & 1;
    D5 = (cmd >> 5) & 1;
    D6 = (cmd >> 6) & 1;
    D7 = (cmd >> 7) & 1;
    LCD_Pulse();
    D4 = cmd & 1;
    D5 = (cmd >> 1) & 1;
    D6 = (cmd >> 2) & 1;
    D7 = (cmd >> 3) & 1;
    LCD_Pulse();
}

void LCD_Char(unsigned char data) {
    RS = 1;
    D4 = (data >> 4) & 1;
    D5 = (data >> 5) & 1;
    D6 = (data >> 6) & 1;
    D7 = (data >> 7) & 1;
    LCD_Pulse();
    D4 = data & 1;
    D5 = (data >> 1) & 1;
    D6 = (data >> 2) & 1;
    D7 = (data >> 3) & 1;
    LCD_Pulse();
}

void LCD_Init(void) {
    __delay_ms(15);
    LCD_Command(0x02);
    LCD_Command(0x28);
    LCD_Command(0x0C);
    LCD_Command(0x06);
    LCD_Command(0x01);
    __delay_ms(2);
}

void LCD_Clear(void) {
    LCD_Command(0x01);
    __delay_ms(2);
}

void LCD_SetCursor(unsigned char row, unsigned char col) {
    unsigned char pos = (row == 1) ? 0x80 : 0xC0;
    pos += (col - 1);
    LCD_Command(pos);
}

void LCD_String(const char *msg) {
    while (*msg) LCD_Char(*msg++);
}

// ==== GPS PARSER ====
void parseGPGGA(char *nmea) {
    char *token;
    unsigned char field = 0;
    token = strtok(nmea, ",");

    while (token != NULL) {
        field++;
        switch (field) {
            case 2: strcpy(hora, token); break;
            case 3: strcpy(lat, token); break;
            case 5: strcpy(lon, token); break;
            case 10: strcpy(alt, token); break;
        }
        token = strtok(NULL, ",");
    }
}

// ==== MOSTRAR DATOS ====
void mostrarDatos(void) {
    char linea1[17], linea2[17];

    LCD_Clear();
    sprintf(linea1, "Hora:%c%c:%c%c:%c%c", hora[0], hora[1], hora[2], hora[3], hora[4], hora[5]);
    LCD_SetCursor(1, 1);
    LCD_String(linea1);

    sprintf(linea2, "Alt:%sm", alt);
    LCD_SetCursor(2, 1);
    LCD_String(linea2);
    __delay_ms(3000);

    LCD_Clear();
    sprintf(linea1, "Lat:%s", lat);
    LCD_SetCursor(1, 1);
    LCD_String(linea1);

    sprintf(linea2, "Lon:%s", lon);
    LCD_SetCursor(2, 1);
    LCD_String(linea2);
    __delay_ms(3000);
}

